```{r child_lineage, context="server"}
output$lineage <- renderPlotly({
	options(warn=0)

	this.eid <- ieid2()
	this.ef <- ief2()

	# warning(this.eid)
	# warning(this.ef)

	if(this.eid==""){
	    validate(
	      	need(this.eid!="",
	      		"Please choose an essential gene.\nPerturbation scores across 423 cell lines for the gene will be shown here.")
		)
	}else{

		this.sym <- df.0$sym.all[df.0$eid==this.eid]

		ef.1 <- data.frame(ef=this.ef,DepMap_ID=names(this.ef),stringsAsFactors=FALSE) %>%
			left_join(cl.info,by="DepMap_ID") %>%
			mutate(cell.name=sub("^([^_]+)_.+","\\1",CCLE_Name))

		med.ef <- tapply(ef.1$ef,ef.1$lineage,mean)
		o <- order(med.ef,decreasing=F)
		cell.levs <- names(med.ef)[o]

		ef.1 <- ef.1 %>% 
			mutate(lineage=factor(lineage,levels=cell.levs)) %>%
			mutate(text=paste0(
				"Cell: ",cell.name,"<br />",
				"Type: ",lineage,"<br />",
				"Subtype: ",lineage_subtype,"<br />",
				"Sub-subtype: ",lineage_sub_subtype,"<br />",
				"Efficacy: ",round(ef,3),"<br />"))

		pvio <- ef.1 %>%
			ggplot(aes(x=lineage,y=ef)) +
			geom_violin(scale="area",aes(fill=lineage,color=lineage)) +
			geom_jitter(height = 0, width = 0.2, size=.5) +
			coord_flip() +
			theme_bw() +
			theme(legend.position="none",plot.margin=unit(c(0,0,0,0),"lines"),
			  axis.text=element_text(size=8),axis.title=element_text(size=10),
			  plot.title=element_text(size=15, hjust=0.5),
			  axis.text.x = element_text(angle = 0)) +
			ggtitle(this.sym) + 
			labs(x="",y="Combined efficacy score")

		ply <- ggplotly(pvio) %>% config(displayModeBar=F)
		ndata <- length(ply$x$data)
		for(i in seq(ndata-1))ply$x$data[[i]]$hoverinfo <- "none"
	    ply$x$data[[ndata]]$text <- ef.1$text
		ply
	}
})
```
```{r}
plotlyOutput("lineage")
```

